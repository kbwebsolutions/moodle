define(["jquery","block_learnerscript/ajax","block_learnerscript/ajaxforms","core/str","core/modal_factory","core/modal_events","core/ajax","core/notification","block_learnerscript/bootstrapnotify"],function(l,a,t,e,i,r,c,o){return helper={sendmessage:function(s,n){e.get_strings([{key:"sendmessage",component:"block_learnerscript"},{key:"messageconformation",component:"block_learnerscript"},{key:"messagesent",component:"block_learnerscript"}]).then(function(r){var e=s.userid,t=s.reportinstance,a="form_sendsms"+e,i=l("#sendsms_"+t+"_"+e).parents("table");l("#ls_sendsms_"+t+"_"+e).length<1&&l("#sendsms_"+t+"_"+e).append('<div id="ls_sendsms_'+t+"_"+e+'" class="sendmessage"><div class="messageloading"></div><form id="'+a+'" ><textarea id="text_'+a+'" type="text" name="message"></textarea><input type="submit" value="Submit"></form></div>');var o=l("#ls_sendsms_"+t+"_"+e).dialog({resizable:!0,autoOpen:!1,width:"20%",title:r[0],modal:!1,dialogClass:"sendsmsdialog",show:{effect:"slide",duration:1e3},position:{my:"left",at:"right",of:"#sendsms_"+t+"_"+e,within:i},open:function(e,t){l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var i=l(".ui-icon-closethick").parent();l(i).attr({title:"Close"}),l(".sendmessage").not(this).each(function(){l(this).remove()})},close:function(e,t){l(this).dialog("destroy").remove()}});o.dialog("open"),l("#"+a).submit(function(e){e.preventDefault();var i=require("block_learnerscript/helper");if(document.getElementById("text_"+a).value){url=require("core/url"),l(".messageloading").html('<center><img src="'+url.imageUrl("loader","block_learnerscript")+'" alt="Message Sending" title="Message Sending"/></center>'),l("#"+a).hide();var t=c.call([{methodname:"core_message_send_instant_messages",args:{messages:[{touserid:s.userid,text:l("#"+a).serializeObject().message,textformat:0}]}}])}else l(".messageloading").html('<div class="alert alert-danger">You must supply a value here</div>');t[0].done(function(e){var t=r[2]+n;i.notifications(t),o.dialog("close")}).fail(function(e){l(".messageloading").html('<div class="alert alert-warning">'+e.message+"</div>")})})})},ViewReportFilters:function(e){l("."+e.activefilter).toggleClass("show"),l("."+e.inactivefilter).removeClass("show")},deleteConfirm:function(s){return e.get_strings([{key:"deleteconfirmation",component:"block_learnerscript"},{key:"deleteallconfirm",component:"block_learnerscript"},{key:"graphdeleted",component:"block_learnerscript"},{key:"graphcannotbedeleted",component:"block_learnerscript"}]).then(function(o){i.create({title:o[0],type:i.types.SAVE_CANCEL,body:o[1]}).done(function(t){(this.modal=t).setSaveButtonText("Confirm"),t.getRoot().on(r.save,function(e){e.preventDefault();var a=require("block_learnerscript/helper");c.call([{methodname:"block_learnerscript_"+s.action,args:s}])[0].done(function(e){if(e.disabledelete)a.notifications(o[3],"danger");else{var t=l("#report_plottabs").tabs("option","active"),i=l("#report_plottabs li:eq("+t+")").data("cid"),r=l("#"+s.cid).attr("aria-controls");l("[data-cid='"+s.cid+"']").remove(),l("#"+r).remove(),l("#report_plottabs").tabs("destroy").tabs(),l("#report_plottabs").tabs("refresh"),i===s.cid&&0<l("#report_plottabs li:eq(0) a").length?l("#report_plottabs li:eq(0) a").trigger("click"):l("#report_plottabs li:eq(0) a").length<1&&l("#report_plottabs").remove(),a.notifications(o[2])}}).fail(function(e){console.log(e)}),t.hide(),t.destroy()}.bind(this)),t.show(),l(".modal-header button.close").attr("title","Close")}.bind(this))}.bind(this))},validatebasicform:function(e){var i=[];return void 0===e&&l.each(l(".basicparamsform select"),function(e,t){0==l(t).val()&&i.push(0)}),i},Preview:function(e){l(e.container).dialog({dialogClass:"previewpopup",width:"95%",modal:!0,position:{my:"center",at:"center",within:".ls_components"},close:function(){l(this).dialog("destroy")},open:function(){l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var e=l(".ui-icon-closethick").parent();l(e).attr({title:"Close"})}})},Select2Ajax:function(r){l("select[data-select2-ajax='1']").each(function(){var e=l(".dashboard").find(":selected").val(),t=l(this).data("instanceid"),i=t||r.reportid;"rolewiseusers"==r.action&&(r.reportid=l(this).data("reportid")),"userlist"===r.action&&(r.categoryid=e,r.setminimumInputLength=2),l(this).hasClass("select2-hidden-accessible")||l(this).select2({ajax:{data:function(e){return"rolewiseusers"==r.action&&(delete r.schuserslist,delete r.scheduleid,r.roleid=l("#id_role"+i).val()),l.extend(e,r),methodname2=r.action,"userlist"===methodname2?$blockname="block_reportdashboard_":$blockname="block_learnerscript_",e},transport:function(e,t,i){e.data.roleid=e.data.roleid;var r=c.call([{methodname:$blockname+methodname2,args:e.data}]);r[0].done(function(e){e=l.parseJSON(e),t(e)}),r[0].fail(function(e){})},processResults:function(e,t){t.page=t.page||1;var i=!1;return i="userlist"!==r.action&&10*t.page<e.total_count,{results:e.items,pagination:{more:i}}}},escapeMarkup:function(e){return e},minimumInputLength:r.setminimumInputLength||1,maximumSelectionLength:r.maximumSelectionLength,language:{maximumSelected:function(e){if("rolewiseusers"==r.action)return r.roleid=l("#id_role"+i).val(),r.schuserslist=l("#schuserslist"+i).val(),r.scheduleid=l("#scheduleid").val()||-1,"Click <a href='javascript:void(0);' class='seluser' id='addusers"+r.reportid+"'                                                      data-reportid="+r.reportid+" data-scheduleid = "+r.scheduleid+'                         onclick = \'(function(e){ require("block_learnerscript/schedule").manageschusers(                                                     {reportinstance:'+i+", reportid:"+r.reportid+",scheduleid:"+r.scheduleid+",selectedroleid:"+r.roleid+',                                                     schuserslist:"'+r.schuserslist+"\"}) })(event)' > here </a> to add more than "+e.maximum+" users."}},templateResult:function(e){return e.loading?e.text||"Values not supported":e.text||"Values not supported"},templateSelection:function(e){var t;-1==e.id&&"rolewiseusers"==r.action?t="<a href='javascript:void(0)' class='viewschusers'onclick='(function(e){ require(\"block_learnerscript/schedule\").viewschusers(                                             {reportid:"+(e.element.form.dataset.reportid||0)+",scheduleid:"+(e.element.form.dataset.scheduleid||-1)+", reportinstance:"+i+"}) })(event);'>"+e.text+"</a>":t=e.text;return t}}).on("select2:select",function(e){if("reportlist"==r.action){var t=l(this).val();window.location=M.cfg.wwwroot+"/blocks/learnerscript/viewreport.php?id="+t}})})},getQueryParameters:function(e){return(e||document.location.search).replace(/(\?)/,"&").split("&").map(function(e){return this[(e=e.split("="))[0]]=e[1],this}.bind({}))[0]},DrilldownReport:function(){var r=this;l("td a").click(function(e){var t=l(this).attr("href"),i=r.getQueryParameters(t);t.indexOf("viewreport.php")<=0||"download"in i||(e.preventDefault(),r.ReportModelFromLink({container:l(this),url:t}))})},ReportModelFromLink:function(i){var e=i.container.parents().closest("table").attr("id"),t=l("#"+e).width(),r=this.getQueryParameters(i.url),a=parseInt(r.id),o=(l(this).data(),{});i.url.indexOf("viewreport.php")<=0||"download"in r||(l.each(r,function(e,t){0<=e.indexOf("filter")&&(o[e]=t)}),0==l("#reportcontainer"+a).length&&(l("body").append('<div id="reportcontainer'+a+'" style="display:none;"></div>'),reportwidget.CreateDashboardwidget({reportid:a,reporttype:"table",basicparams:JSON.stringify(o),ls_fstartdate:0,ls_fenddate:l.now()}),chart.SparkLineReport()),l("#reportcontainer"+a).dialog({resizable:!0,autoOpen:!1,dialogClass:"drilldown"+a,width:t,title:"",appendTo:"#"+e,modal:!0,position:{my:"center",at:"top",of:"#"+e},open:function(e){l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var t=l(".ui-icon-closethick").parent();l(t).attr({title:"Close"}),l(".drilldown"+a).append("<a href="+i.url+'><span class="reportdashboard_right">View more</span></a>')},close:function(e,t){l(this).dialog("destroy").remove()}}).dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6"))},PlotForm:function(e){url=M.cfg.wwwroot+"/blocks/learnerscript/ajax.php",e.title=e.title?e.title:"Plot Graph",t.init(e,url)},reportCalculations:function(r){e.get_string("calcs","block_learnerscript").then(function(e){M.util.image_url("schedule_icon","block_learnerscript");var t=l(".reportcalculation"+r.reportid).dialog({dialogClass:"calculationspopup",resizable:!1,autoOpen:!1,width:"50%",title:"Calculations",modal:!0,position:{my:"center",at:"center",of:window},open:function(e,t){l(".reportcalculation"+r.reportid).append('<img src="'+M.util.image_url("loading","block_learnerscript")+'" id="loadingimage" />'),l(document).ajaxStop(function(){l("#loadingimage").remove()}),l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var i=l(".ui-icon-closethick").parent();l(i).attr({title:"Close"}),l(this).closest(".ui-dialog").find(".ui-dialog-title").html("Calculations")}});if(r.filters=smartfilter.FilterData(r.reportid),r.filters.ls_fstartdate=l("#ls_fstartdate").val(),r.filters.ls_fenddate=l("#ls_fenddate").val(),void 0===r.filters.filter_courses){var i=l("#ls_courseid").val();1!=i&&(r.filters.filter_courses=i)}r.filters=JSON.stringify(r.filters),r.action="reportcalculations",r.basicparams=r.basicparams||JSON.stringify(smartfilter.BasicparamsData(r.reportid)),a.call({args:r,url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done(function(e){l(".reportcalculation"+r.reportid).closest(".ui-dialog").find(".ui-dialog-title").html(e.reportname+" : Calculations"),l(".reportcalculation"+r.reportid).html(e.table)}).fail(function(e){}),t.dialog("open")}.bind(this))},dropdown:function(e){l("#"+e).toggle()},notifications:function(e,t){t=t||"success",l.notify({message:e},{type:t})},tabsdraggable:function(e){l(".ls-plotgraphs_list").sortable({cursor:"move",axis:"y",update:function(e,t){var i=l(".ls-plotgraphs_list").sortable("toArray",{attribute:"data-cid"}).toString();a.call({args:{action:"tabsposition",reportid:l(".ls-plotgraphs_list").data("reportid"),component:"plot",elementsorder:i},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"})}})}}});