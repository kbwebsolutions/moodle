define(["jquery","block_learnerscript/ajax","block_learnerscript/reportwidget","block_learnerscript/report","block_learnerscript/jquery.serialize-object"],function(c,r,e,t){c(".filterform #id_filter_coursecategories");var l=c(".basicparamsform #id_filter_courses"),n=c(".basicparamsform #id_filter_users"),d=c(".basicparamsform #id_filter_activity"),p=(c(".filterform #id_filter_coursecategories"),c(".filterform #id_filter_courses")),f=c(".filterform #id_filter_users"),u=c(".filterform #id_filter_activity");return smartfilter={DurationFilter:function(e,r){var t=new Date,i=(t.getFullYear(),t.getMonth(),t.getDate(),"");if("clear"!==e){switch(c("#ls_fenddate").val(t.getTime()/1e3),e){case"week":i=new Date(t.getFullYear(),t.getMonth(),t.getDate()-7);break;case"month":i=new Date(t.getFullYear(),t.getMonth()-1,t.getDate());break;case"year":i=new Date(t.getFullYear()-1,t.getMonth(),t.getDate());break;case"custom":c("#customrange").show()}""!=i&&c("#ls_fstartdate").val(i.getTime()/1e3)}else c("#ls_fenddate").val(""),c("#ls_fstartdate").val("");if("custom"!==e){var a=c('input[name="reportid"]').val();0!=r?require(["block_learnerscript/reportwidget"],function(e){e.DashboardTiles(),e.DashboardWidgets()}):require(["block_learnerscript/report"],function(e){e.CreateReportPage({reportid:a,instanceid:a,reportdashboard:r})}),c("#customrange").val(""),c("#customrange").hide()}},FilterData:function(e){return c(".filterform"+e).serializeObject()},BasicparamsData:function(e){return c(".basicparamsform"+e).serializeObject()},CourseData:function(e){var r=!1;(0<d.length||0<u.length)&&(0<d.length&&(r=!0),0<e.courseid&&0<e.categoryid&&this.CourseActivities({categoryid:e.categoryid,courseid:e.courseid,firstelementactive:r,activityid:e.filterrequests.filter_activity})),(0<n.length||0<f.length)&&(0<n.length&&(r=!0),this.EnrolledUsers({courseid:e.courseid,categoryid:e.categoryid,reporttype:e.reporttype,components:e.components,firstelementactive:r}))},categoryCourses:function(o){if(0<c("#id_filter_coursecategories").find(":selected").val()){var e=r.call({args:{action:"categorycourses",basicparam:!0,reporttype:o.reporttype,categoryid:o.categoryid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}),s=this;e.done(function(e){var t="";c.each(e,function(e,r){t+="<option value = "+e+">"+r+"</option>"}),c("#id_filter_courses").html(t);var r=c(".basicparamsform #id_filter_courses").find(":selected").val();if(0!=r&&null!=r||c(".basicparamsform #id_filter_courses").val(c(".basicparamsform #id_filter_courses option:eq(1)").val()),0<d.length||0<u.length){var i=c(".basicparamsform #id_filter_courses").find(":selected").val();s.CourseActivities({categoryid:o.categoryid,courseid:i})}if(0<l.length&&(0<f.length||0<n.length)){var a=c(".basicparamsform #id_filter_courses").find(":selected").val();s.EnrolledUsers({categoryid:o.categoryid,courseid:a})}})}},CategoryUsers:function(a){var o=c("#id_filter_coursecategories").find(":selected").val();if(0<o){var e=r.call({args:{action:"categoryusers",basicparam:!0,reporttype:a.reporttype,categoryid:a.categoryid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}),s=this;e.done(function(e){var t="";c.each(e,function(e,r){t+="<option value = "+e+">"+r+"</option>"}),c("#id_filter_users").html(t);var r=c(".basicparamsform #id_filter_users").find(":selected").val();0!=r&&null!=r||c(".basicparamsform #id_filter_users").val(c(".basicparamsform #id_filter_users option:eq(1)").val());var i=c("#id_filter_users").find(":selected").val();0<p.length&&(0<n.length||0<f.length)&&s.UserCourses({categoryid:o,userid:i,reporttype:a.reporttype})})}},CourseActivities:function(t){var i=t.element||c("#id_filter_activity");activityid=parseInt(t.activityid)||0;i.val();i.find("option").remove().end().append("<option value=0>Select Activity</option>"),0<=t.courseid&&r.call({args:{action:"courseactivities",basicparam:!0,courseid:t.courseid,categoryid:t.categoryid},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done(function(e){c.each(e,function(e,r){if(0==(e=parseInt(e)))return!0;e!=activityid?i.append(c("<option></option>").attr("value",e).text(r)):i.append(c("<option></option>").attr("value",e).attr("selected","selected").text(r))});var r=c(".basicparamsform #id_filter_activity").find(":selected").val();0!=r&&null!=r||c(".basicparamsform #id_filter_activity").val(c(".basicparamsform #id_filter_activity option:eq(1)").val()),0<i.parents(".basicparamsform").length&&t.onloadtrigger&&c(".basicparamsform #id_filter_apply").trigger("click")})},UserCourses:function(i){var a=c("#id_filter_courses").find(":selected").val(),o=c("#id_filter_coursecategories").find(":selected").val();c("#id_filter_courses").find("option").remove().end().append('<option value="">Select Course</option>'),0<=i.userid&&r.call({args:{action:"usercourses",basicparam:!0,userid:i.userid,categoryid:i.categoryid,reporttype:i.reporttype},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done(function(t){c.each(t,function(e,r){if(0==e)return!0;e==Object.keys(t)[0]&&1==i.firstelementactive||e==a&&1==i.firstelementactive?(c("#id_filter_courses").append(c("<option></option>").attr("value",e).attr("selected","selected").text(r)),void 0!==i.triggercourseactivities&&1==i.triggercourseactivities&&smartfilter.CourseActivities({categoryid:o,courseid:e})):c("#id_filter_courses").append(c("<option></option>").attr("value",e).text(r))})})},EnrolledUsers:function(e){var t=e.element||c("#id_filter_users"),i=t.val();t.find("option").remove().end().append("<option value=0>Select User</option>"),r.call({args:{action:"enrolledusers",basicparam:!0,courseid:e.courseid,categoryid:e.categoryid,reporttype:e.reporttype,component:e.components},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done(function(e){c.each(e,function(e,r){if(0==e)return!0;e!=i?t.append(c("<option></option>").attr("value",e).text(r)):t.append(c("<option></option>").attr("value",e).attr("selected","selected").text(r))});var r=c(".basicparamsform #id_filter_users").find(":selected").val();0==r||null==r?c(".basicparamsform #id_filter_users").val(c(".basicparamsform #id_filter_users option:eq(1)").val()):(c(".basicparamsform #id_filter_users").val(r),c(".basicparamsform #id_filter_users option[value='"+r+"']").attr("selected","selected"))})}}});