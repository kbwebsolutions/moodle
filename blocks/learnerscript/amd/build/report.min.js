define(["block_learnerscript/select2","block_learnerscript/responsive.bootstrap","block_learnerscript/reportwidget","block_learnerscript/chart","block_learnerscript/smartfilter","block_learnerscript/helper","block_learnerscript/ajaxforms","jquery","block_learnerscript/radioslider","block_learnerscript/flatpickr","jqueryui"],function(e,r,t,a,l,i,o,c,s,n){c(".basicparamsform #id_filter_coursecategories");var p,d=c(".basicparamsform #id_filter_courses"),f=c(".basicparamsform #id_filter_users"),h=c(".basicparamsform #id_filter_activity"),g=(c(".filterform #id_filter_coursecategories"),c(".filterform #id_filter_courses")),m=c(".filterform #id_filter_users"),u=c(".filterform #id_filter_activity"),_=(c(".filterform #id_filter_modules"),0);return p={init:function(o){if(c.ui.dialog.prototype._focusTabbable=c.noop,c.fn.dataTable.ext.errMode="none",c("select[data-select2='1']").select2({theme:"classic"}).on("select2:selecting",function(e){c(this).val()&&c(this).data("maximumSelectionLength")&&c(this).val().length>=c(this).data("maximumSelectionLength")&&(e.preventDefault(),c(this).select2("close"))}),c("#reportsearch").val(o.reportid).trigger("change.select2"),c("#reportsearch").change(function(){var e=c(this).find(":selected").val();window.location=M.cfg.wwwroot+"/blocks/learnerscript/viewreport.php?id="+e}),s.init(c("#segmented-button"),{size:"medium",animation:!0,reportdashboard:!1}),n("#customrange",{mode:"range",onOpen:function(e,r,t){t.clear()},onClose:function(e,r,t){c("#ls_fstartdate").val(e[0].getTime()/1e3),c("#ls_fenddate").val(e[1].getTime()/1e3+86400),require(["block_learnerscript/report"],function(e){e.CreateReportPage({reportid:o.reportid,instanceid:o.reportid,reportdashboard:!1})})}}),void 0===d&&void 0===g||c("#id_filter_courses").change(function(){o.courseid=c(this).find(":selected").val(),o.categoryid=c("#id_filter_coursecategories").find(":selected").val(),0<d.length&&(0<m.length||0<f.length)&&l.EnrolledUsers({categoryid:o.categoryid,courseid:o.courseid}),(0<d.length||0<g.length)&&(0<u.length||0<h.length)&&l.CourseActivities({categoryid:o.categoryid,courseid:o.courseid})}),c("#id_filter_users").change(function(){var e=c(this).find(":selected").val(),r=c("#id_filter_coursecategories").find(":selected").val();c("#id_filter_courses").find(":selected").val();0<f.length&&0<g.length&&l.UserCourses({categoryid:r,userid:e,reporttype:o.reporttype,firstelementactive:a})}),c("#id_filter_coursecategories").change(function(){var e=c(this).find(":selected").val();c("#id_filter_users").find(":selected").val();if(0<g.length&&1==o.basicparams.length&&l.categoryCourses({categoryid:e,reporttype:o.reporttype,firstelementactive:a}),0<m.length&&1==o.basicparams.length&&l.CategoryUsers({categoryid:e,reporttype:o.reporttype,firstelementactive:a}),0<m.length&&2==o.basicparams.length&&"courses"==o.basicparams[1].name||0<e&&0<f.length&&"users"==o.basicparams[1].name&&(0<f.length&&(a=!0),l.CategoryUsers({categoryid:e,reporttype:o.reporttype,firstelementactive:a})),0<g.length&&2==o.basicparams.length&&"users"==o.basicparams[1].name);else if(0<e&&0<d.length&&"courses"==o.basicparams[1].name){0<d.length&&(a=!0);o.filterrequests.filter_courses;l.categoryCourses({categoryid:e,reporttype:o.reporttype,firstelementactive:a})}}),schedule.SelectRoleUsers(),null!=o.basicparams){var a=!1;"coursecategories"==o.basicparams[0].name&&(c("#id_filter_coursecategories").trigger("change"),0<h.length&&_++)}c(".filterform"+o.reportid+" .fitemtitle").hide(),c(".filterform"+o.reportid+" .felement").attr("style","margin:0"),c(".basicparamsform"+o.reportid+" .fitemtitle").hide(),c(".basicparamsform"+o.reportid+" .felement").attr("style","margin:0"),c(".filterform #id_filter_clear").click(function(e){var i=0;c(".filterform"+o.reportid).trigger("reset");c(this).parent().find("#id_filter_activity"),c(this).parent().find("#id_filter_users");var r=c("#id_filter_coursecategories").find(":selected").val(),t=c("#id_filter_courses").find(":selected").val();c("#id_filter_users").find(":selected").val();0<m.length&&((0<g.length||0<d.length)&&(0<d.length&&(a=!0),l.EnrolledUsers({categoryid:r,courseid:t,reporttype:o.reporttype,components:o.components})),c("select[data-select2='1']").select2("destroy").select2({theme:"classic"})),0<g.length&&(0<m.length||0<f.length?l.CategoryUsers({categoryid:r,reporttype:o.reporttype,firstelementactive:a,triggercourseactivities:!0}):l.categoryCourses({categoryid:r,reporttype:o.reporttype,firstelementactive:a}),(0<u.length||0<h.length)&&l.CourseActivities({categoryid:r,courseid:t}),c("select[data-select2='1']").select2("destroy").select2({theme:"classic"})),0<u.length&&((0<g.length||0<d.length)&&l.CourseActivities({categoryid:r,courseid:t}),c("select[data-select2='1']").select2("destroy").select2({theme:"classic"})),c("select[data-select2='1']").select2("destroy").select2({theme:"classic"}),0<c(".basicparamsform #id_filter_apply").length?c(document).ajaxComplete(function(e,r,t){if(0<t.url.indexOf("blocks/learnerscript/ajax.php")){if(void 0!==t.data){var a=c.parseJSON(t.data);void 0!==a.basicparam&&1==a.basicparam&&i++}o.basicparams.length==i&&c(".basicparamsform #id_filter_apply").trigger("click",[!0])}}):(o.reporttype=c(".ls-plotgraphs_listitem.ui-tabs-active").data("cid"),p.CreateReportPage({reportid:o.reportid,reporttype:o.reporttype,instanceid:o.reportid})),c(".filterform #id_filter_clear").attr("disabled","disabled")}),c(".basicparamsform #id_filter_apply,.filterform #id_filter_apply").click(function(e,r){var t=i.validatebasicform(r);e.preventDefault(),e.stopImmediatePropagation(),c(".filterform"+o.reportid).show(),o.instanceid=o.reportid,"Get Report"!=e.currentTarget.value&&c(".filterform #id_filter_clear").removeAttr("disabled"),-1!=c.inArray(0,t)?(c("#report_plottabs").hide(),c("#reportcontainer"+o.reportid).html("<div class='alert alert-info'>No data available</div>")):(c("#report_plottabs").show(),p.CreateReportPage({reportid:o.reportid,reporttype:o.reporttype,instanceid:o.instanceid,reportdashboard:!1}))}),null==o.basicparams?p.CreateReportPage({reportid:o.reportid,reporttype:o.reporttype,instanceid:o.reportid,reportdashboard:!1}):1==o.basicparams.length?c(".basicparamsform #id_filter_apply").trigger("click",[!0]):c(document).ajaxComplete(function(e,r,t){if(0<t.url.indexOf("blocks/learnerscript/ajax.php")){if(void 0!==t.data){var a=c.parseJSON(t.data);void 0!==a.basicparam&&1==a.basicparam&&_++}o.basicparams.length==_&&"plotforms"!=a.action&&"pluginlicence"!=a.action&&c(".basicparamsform #id_filter_apply").trigger("click",[!0])}}),$tabs=c("#report_plottabs").tabs().addClass("ui-tabs-vertical ui-helper-clearfix"),c("#report_plottabs li").removeClass("ui-corner-top").addClass("ui-corner-left"),i.tabsdraggable($tabs)},CreateReportPage:function(e){0==e.reportdashboard&&(e.reporttype=c(".ls-plotgraphs_listitem.ui-tabs-active").data("cid")),t.CreateDashboardwidget({reportid:e.reportid,reporttype:"table",instanceid:e.reportid,reportdashboard:e.reportdashboard}),a.HighchartsAjax({reportid:e.reportid,action:"generate_plotgraph",cols:e.cols,reporttype:e.reporttype})},generate_plotgraph:function(e){switch(e.containerid="plotreportcontainer"+e.reportinstance,e.type){case"pie":a.piechart(e);break;case"line":case"bar":case"column":a.lbchart(e);break;case"solidgauge":a.solidgauge(e);break;case"combination":a.combinationchart(e);break;case"map":a.WorldMap(e);break;case"treemap":a.TreeMap(e)}},ReportDatatable:function(s){var e={},r=s.instanceid?s.instanceid:s.reportid;if(e.filters=s.filters,e.basicparams=s.basicparams||JSON.stringify(l.BasicparamsData(r)),e.reportid=s.reportid,e.columns=s.columns,c.fn.dataTable.pipeline=function(e){var o=c.extend({url:"",data:null,method:"GET"},e);return function(e,r,t){var a=e.start,i=(e.start,e.length);void 0!==s.data&&1==e.draw?(json=s.data,json.draw=e.draw,json.data.splice(0,a),json.data.splice(i,json.data.length),r(json)):(e.start=a,e.length=i,c.extend(e,o.data),t.jqXHR=c.ajax({type:o.method,url:o.url,data:e,dataType:"json",cache:!1,success:function(e){r(e)}}))}},"Users profile"==s.reportname||"Course profile"==s.reportname)var t=[[50,100,-1],["Show 50","Show 100","Show All"]];else t=[[10,25,50,100,-1],["Show 10","Show 25","Show 50","Show 100","Show All"]];c("#reporttable_"+r).DataTable({processing:!0,serverSide:!0,destroy:!0,dom:'<"co_report_header"Bf <"report_header_skew"  <"report_header_skew_content" Bl<"report_header_showhide" ><"report_calculation_showhide" >> > > tr <"co_report_footer"ip>',ajax:c.fn.dataTable.pipeline({type:"POST",url:M.cfg.wwwroot+"/blocks/learnerscript/components/datatable/server_processing.php?sesskey="+M.cfg.sesskey,data:e}),columnDefs:s.columnDefs,fnDrawCallback:function(e,r){a.SparkLineReport(),i.DrilldownReport()},oScroll:{},responsive:!0,fnInitComplete:function(){this.fnAdjustColumnSizing(!0),c(".drilldown"+r+" .ui-dialog-title").html(s.reportname),"Users profile"!=s.reportname&&"Course profile"!=s.reportname||(c("#reporttable_"+r+"_wrapper .co_report_header").remove(),c("#reporttable_"+r+"_wrapper .co_report_footer").remove()),c(".download_menu"+r+" li a").each(function(e){var t=c(this).attr("href");if(void 0!==s.basicparams){var r=JSON.parse(s.basicparams);c.each(r,function(e,r){0==e.indexOf("filter_")&&(t+="&"+e+"="+r)})}if(void 0!==s.filters){var a=JSON.parse(s.filters);c.each(a,function(e,r){0==e.indexOf("filter_")&&(t+="&"+e+"="+r),0==e.indexOf("ls_")&&(t+="&"+e+"="+r)})}c(this).attr("href",t)})},fnRowCallback:function(e,r,t){return c(e).children().each(function(e,r){c(r).css("word-break",s.columnDefs[e].wrap),c(r).css("width",s.columnDefs[e].width)}),e},autoWidth:!1,aaSorting:[],language:{paginate:{previous:"<",next:">"},sProcessing:"<img src='"+M.util.image_url("loading","block_learnerscript")+"'>",search:"_INPUT_",searchPlaceholder:"Search",lengthMenu:"_MENU_",emptyTable:"<div class='alert alert-info'>No data available</div>"},lengthMenu:t});c("#page-blocks-learnerscript-viewreport #reporttable_"+s.reportid+"_wrapper div.report_header_showhide").html(c("#export_options"+s.reportid).html()),0<c(".reportcalculation"+s.reportid).length&&c("#page-blocks-learnerscript-viewreport #reporttable_"+s.reportid+"_wrapper div.report_calculation_showhide").html('<img src="'+M.util.image_url("calculationicon","block_learnerscript")+"\" onclick=\"(function(e){ require('block_learnerscript/helper').reportCalculations({reportid:"+s.reportid+'}) })(event)" title ="Calculations" />'),c("#export_options"+s.reportid).remove()}}});