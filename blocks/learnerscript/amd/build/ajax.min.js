define(["jquery","core/config","core/log","core/modal_factory"],function(s,a,n,d){function t(e){var r=this;if(null!==e)if(e.error){if(e.cap||e.debuginfo||e.errorcode){var o=e.msg||e.error;d.create({title:e.type||e.errorcode,body:"<p>"+o+"</p>",footer:""}).done(function(e){dialogue=e,dialogue.show()})}else n.error(e.type+": "+e.msg);r.deferred.reject(e)}else void 0!==e?r.deferred.resolve(e):exception=new Error("missing response"),"undefined"!=typeof exception&&null!==exception&&r.deferred.reject(exception)}function f(e,r,o){c?(n.error("Page unloaded."),n.error(o)):(n.error("Page Not Responding."),n.error(o),this.deferred.reject(o))}var c=!1;return{call:function(e,r,o){s(window).bind("beforeunload",function(){c=!0});var n,d;void 0===o&&(o=!0),void 0===r&&(r=!0),n=e.args,e.deferred=s.Deferred(),d=e.deferred.promise(),void 0!==e.done&&e.deferred.done(e.done),void 0!==e.fail&&e.deferred.fail(e.fail);var i={type:"POST",data:n=JSON.stringify(n),context:e,dataType:"json",processData:!1,global:!0,async:r,contentType:"application/json",beforeSend:function(){e.loading&&s(e.loading).show()},success:function(){e.loading&&s(e.loading).hide("fast")}};return r?s.ajax(e.url+"?sesskey="+a.sesskey,i).done(t).fail(f):(i.success=t,i.error=f,s.ajax(e.url+"?sesskey="+a.sesskey,i)),d}}});