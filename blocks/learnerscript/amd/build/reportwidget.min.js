define(["jquery","core/ajax","block_learnerscript/report","block_learnerscript/smartfilter"],function(n,i,t,l){return reportwidget={DashboardWidgets:function(a){var o=this,i=(a=a||{container:".report_dashboard_container"},l.FilterData(a.reportid));n(".loader").show(),n(a.container).each(function(){var t=n(this).data("reportid"),e=n(this).data("blockinstance");if(""!=n(this).val()){e=n("#reportcontainer"+reportinstance).data("blockinstance");a.reporttype=n("#reporttype_"+e+"  :selected").val();var r={reportid:t,reporttype:a.reporttype};return n.extend(r,i),o.CreateDashboardwidget(r),!1}a.reporttype=n("#reporttype_"+e+"  :selected").val(),void 0===a.reporttype&&(a.reporttype=n(this).data("reporttype")),o.CreateDashboardwidget({reportid:t,reporttype:a.reporttype,instanceid:e})})},DashboardTiles:function(){var t=this;ls_fstartdate=n("#ls_fstartdate").val(),ls_fenddate=n("#ls_fenddate").val();var e=n("#ls_courseid").val();n(".tiles_information").each(function(){t.CreateDashboardTile({blockinstanceid:n(this).data("instanceid"),reportid:n(this).data("reportid"),reporttype:n(this).data("reporttype"),ls_fstartdate:ls_fstartdate,ls_fenddate:ls_fenddate,courseid:e})})},CreateDashboardTile:function(o){n("#inst"+o.blockinstanceid+" .tiles_information table tr").html("");var t=o.blockinstanceid,e={};if(e.ls_fstartdate=n("#ls_fstartdate").val(),e.ls_fenddate=n("#ls_fenddate").val(),void 0===e.filter_coursecategories){var r=n("#ls_categoryid").val();0!=r&&(e.filter_coursecategories=r)}i.call([{methodname:"block_learnerscript_generate_plotgraph",args:{instanceid:o.blockinstanceid,reportid:o.reportid,courseid:o.courseid,filters:JSON.stringify(e),reporttype:o.reporttype},loading:"#reportloading_"+o.blockinstanceid}])[0].done(function(r){r=JSON.parse(r);var a=[];"table"!=o.reporttype?(n.extend(r.plot,o),r.plot.container="#plotreportcontainer"+t,!0===r.plot.error?n("#plotreportcontainer"+t).html('<p class="alert alert-warning">'+r.plot.messages+"</p>"):0==r.plot.data.length?n(r.plot.container).html("<div class='alert alert-info'>Data Not Available.</div>"):(r.plot.reportinstance=t,require(["block_learnerscript/report"],function(t){t.generate_plotgraph(r.plot)}))):void 0!==r.plot&&(0<r.plot.data.length?(n(r.plot.data).each(function(t,e){[],a=[],e.head,a=e.data}),n(r.plot.categorydata).each(function(t,e){1==r.plot.categorydata.length?isNaN(a[0][t])?n("#inst"+o.blockinstanceid+" .tiles_information table tr").append("<td><p>"+r.plot.name+"  </p><h5><b>"+a[0][t]+"</b></h5></td>"):n("#inst"+o.blockinstanceid+" .tiles_information table tr").append("<td><h1> "+a[0][t]+" </h1><p>"+r.plot.name+"</p></td>"):n("#inst"+o.blockinstanceid+" .tiles_information table tr").append("<td>"+e+" : <b> "+a[t]+" </b></td>")})):(n("#inst"+o.blockinstanceid+" .tiles_information table tr").html("<div class='alert alert-info'> No Data Available.</div>"),n("#inst"+o.blockinstanceid+" .dashboard_tiles").css("color","#4B4B4B")),n("#reportloading_"+o.blockinstanceid).css("display","none"))})},CreateDashboardwidget:function(o){var t=o.instanceid||o.reportid;if(o.filters=l.FilterData(t),o.columnDefs="",o.filters.ls_fstartdate=n("#ls_fstartdate").val(),o.filters.ls_fenddate=n("#ls_fenddate").val(),void 0===o.filters.filter_courses){var e=n("#ls_courseid").val();1!=e&&(o.filters.filter_courses=e)}if(void 0===o.filters.filter_coursecategories){var r=n("#ls_categoryid").val();0!=r&&(o.filters.filter_coursecategories=r)}o.selectreport&&(n("#reportcontainer"+t).attr("data-reporttype",o.singleplot),n("#plotreportcontainer"+t).attr("data-reporttype",o.singleplot),delete o.selectreport),o.filters=JSON.stringify(o.filters),o.action="generate_plotgraph",n(".download_menu"+t+" li a").each(function(t){var r=n(this).attr("href");if(void 0!==o.basicparams){var e=JSON.parse(o.basicparams);n.each(e,function(t,e){0==t.indexOf("filter_")&&(r+="&"+t+"="+e)})}if(void 0!==o.filters){var a=JSON.parse(o.filters);n.each(a,function(t,e){0==t.indexOf("filter_")&&(r+="&"+t+"="+e),0==t.indexOf("ls_")&&(r+="&"+t+"="+e)})}n(this).attr("href",r)}),o.basicparams=o.basicparams||JSON.stringify(l.BasicparamsData(t)),void 0!==o.singleplot?(n("#reportcontainer"+t).html(""),n("#plotreportcontainer"+t).html("")):"table"==o.reporttype?n("#reportcontainer"+t).html(""):n("#plotreportcontainer"+t).html("");var a=i.call([{methodname:"block_learnerscript_generate_plotgraph",args:o,loading:"#reportloading_"+o.reportid}]);n("#reportloadingimage").length<=0&&("table"==o.reporttype?n("#reportcontainer"+o.reportid).prepend('<img src="'+M.util.image_url("loading","block_learnerscript")+'" id="reportloadingimage" />'):n("#plotreportcontainer"+o.reportid).prepend('<img src="'+M.util.image_url("loading","block_learnerscript")+'" id="reportloadingimage" />')),a[0].done(function(e){"table"==((e=n.parseJSON(e)).reporttype||o.reporttype)?void 0===e.data&&e.emptydata?n("#reportcontainer"+t).html(e.tdata):(n("#reporttable_"+o.reportid).length||n("#reportcontainer"+t).html(e.tdata),n(document).ajaxStop(function(){n("#reportloadingimage").remove()}),o.columnDefs=e.columnDefs,o.data=e.data,o.reportname=e.reportname,require(["block_learnerscript/report"],function(t){t.ReportDatatable(o)})):(n.extend(e.plot,o),e.plot.container="#plotreportcontainer"+t,n(document).ajaxStop(function(){n("#reportloadingimage").remove()}),!0===e.plot.error?n("#plotreportcontainer"+t).html('<p class="alert alert-warning">'+e.plot.messages+"</p>"):e.plot.data&&0<e.plot.data.length?(e.plot.reportinstance=t,require(["block_learnerscript/report"],function(t){t.generate_plotgraph(e.plot)})):n(e.plot.container).html('<p class="alert alert-warning">No data available</p>'))}).fail(function(t){})}}});