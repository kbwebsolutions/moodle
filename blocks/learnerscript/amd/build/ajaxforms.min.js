define(["jquery","core/str","core/modal_factory","core/modal_events","core/fragment","block_learnerscript/ajax","block_learnerscript/schedule","core/yui","core/templates","core/modal","block_learnerscript/helper","jqueryui"],function(d,p,t,e,o,i,m,r,u,n,a){function s(t,e){this.args=t,this.contextid=1,this.url=e,this.nodeContent=t.nodeContent||"ajaxForm",this.init(this.args)}return s.prototype.modal=null,s.prototype.contextid=-1,s.prototype.init=function(s){var t=this.getBody(),l=this,c="";t.done(function(t){d("body").append("<div class='"+l.nodeContent+"'></div>"),u.replaceNodeContents("."+l.nodeContent,t.html,"");var e="",o="#viewreport"+s.reportid,i="80%",r="center top",n="center top";"schreportform"==s.action?(c="schreportform",e="<img class='dialog_title_icon' alt='Schedule' src='"+M.util.image_url("schreportform","block_learnerscript")+"' />",o="#inst"+s.instanceid,i="60%",n=r="center"):"advancedcolumns"==s.action?(c="advancedcolumns",o=".ls_components",i="60%",n=r="center top"):"sendreportemail"==s.action&&(c="sendreportemail",e="<img class='dialog_title_icon' alt='Email' src='"+M.util.image_url("email_icon","block_learnerscript")+"'/>",o="#inst"+s.instanceid,i="60%",n=r="center"),d("head").append(t.javascript);var a=d("."+l.nodeContent).dialog({resizable:!0,autoOpen:!1,width:i,dialogClass:c,title:l.args.title,modal:!0,appendTo:o,position:{my:r,at:n,of:o,within:o},close:function(t,e){d(this).dialog("destroy").remove()},open:function(){d(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var t=d(".ui-icon-closethick").parent();d(t).attr({title:"Close"}),d(this).closest(".ui-dialog").find(".ui-dialog-title").html(e+l.args.title)}});"schreportform"==s.action?(d("."+l.nodeContent+" select[data-select2='1']").select2(),m.SelectRoleUsers()):"sendreportemail"==s.action&&require("block_learnerscript/helper").Select2Ajax({action:"userlist",reportid:s.reportid,maximumSelectionLength:0}),d("."+l.nodeContent+" .mform").bind("submit",function(t){return t.preventDefault(),l.submitFormAjax(this)}),"plotforms"!=s.action||"bar"!=s.pname&&"column"!=s.pname&&"line"!=s.pname||d(document).on("change","#id_calcs",function(){d(this).val()?(d("#id_columnsort").prop("disabled",!0),d("#id_sorting").prop("disabled",!0),d("#id_limit").prop("disabled",!0)):(d("#id_columnsort").prop("disabled",!1),d("#id_sorting").prop("disabled",!1),d("#id_limit").prop("disabled",!1))}),a.dialog("open")}).fail(function(t){})},s.prototype.getBody=function(t){return void 0===t?t=null:this.args.jsonformdata=JSON.stringify(t),i.call({args:this.args,url:this.url},!1)},s.prototype.handleFormSubmissionResponse=function(s){var l=require("block_learnerscript/helper");if(s.formerror){u.replaceNodeContents("."+this.nodeContent,s.html,""),d("head").append(s.javascript);var c=this;d("."+this.nodeContent+" .mform").bind("submit",function(t){t.preventDefault(),c.submitFormAjax(this)}),"schreportform"==this.args.action?(d("."+c.nodeContent+" select[data-select2='1']").select2(),m.SelectRoleUsers()):"sendreportemail"==this.args.action&&(l=require("block_learnerscript/helper")).Select2Ajax({action:"userlist",reportid:this.args.reportid,maximumSelectionLength:0})}else if("columns"==this.args.component){var e=angular.element(".simpleDemo").scope(),o=this.args.advancedcolumn;e.$apply(function(){var t={};t.id=s.data.id,delete s.data.id,t.pluginname=o,t.pluginfullname=o,t.summary="",t.type="selectedcolumns",t.formdata=s.data,e.lists.columns.elements.push(t)}),d("."+this.nodeContent).dialog("destroy").remove()}else if("schreportform"==this.args.action)d("."+this.nodeContent).dialog("close"),p.get_string("reportschedule","block_learnerscript").then(function(t){l.notifications(t)});else if("plotforms"==this.args.action){c=this;d("."+this.nodeContent).dialog("close"),p.get_strings([{key:"graphcreated",component:"block_learnerscript"},{key:"graphupdated",component:"block_learnerscript"}]).then(function(t){var e,o,i;if("add"==c.args.type){l.notifications(t[0]),d("#report_plottabs").removeClass("ui-tabs-vertical ui-helper-clearfix"),d("#report_plottabs li").removeClass("ui-corner-left");d("div#report_plottabs ul li").length;var r=c.args.reportid;e=s.data.id;var n={};if(n.reportid=r,n.chartid=s.data.id,n.reporttype=s.data.id,n.pluginname=c.args.pname,n.chartname=s.data.chartname,n.issiteadmin=!0,n.editicon=M.util.image_url("t/edit"),p.get_string(c.args.pname,"block_learnerscript").then(function(t){n.title=t}),n.cid=s.data.id,n.pname=c.args.pname,n.type="edit",n.deleteicon=M.util.image_url("t/delete"),n.pname=c.args.pname,n.type="edit",0<d("#report_plottabs").length)o="block_learnerscript/tabs",i=n;else{o="block_learnerscript/plottabs";var a={};a.reportid=r,a.multiplot=!0,a.enableplots=!1,a.plottabs=n,i=a}u.render(o,i).done(function(t){d("#report_plottabs").tabs("destroy"),0<d("#report_plottabs").length?d("div#report_plottabs ul").append(t):d("div#reportbox_shadow").after(t),d("#report_plottabs").tabs().addClass("ui-tabs-vertical ui-helper-clearfix"),d("#report_plottabs li").removeClass("ui-corner-top"),d("#report_plottabs li").addClass("ui-corner-left"),d("#report_plottabs").tabs("refresh"),d("#"+s.data.id).trigger("click")})}else"edit"==c.args.type&&(l.notifications(t[1]),e=c.args.cid,d("#lschartname"+e).text(s.data.chartname),d("#"+e).trigger("click"))})}else"sendreportemail"==this.args.action?(d("."+this.nodeContent).dialog("close"),p.get_string("mailscheduled","block_learnerscript").then(function(t){l.notifications(t)})):window.location.reload()},s.prototype.handleFormSubmissionFailure=function(t){},s.prototype.submitFormAjax=function(t){if(skipClientValidation)return d("."+this.nodeContent).dialog("destroy").remove(),!0;this.args.jsonformdata=d(t).serialize();var e=this;i.call({args:this.args,url:this.url}).done(function(t){return e.handleFormSubmissionResponse(t)}).fail(function(t){console.log(t)})},s.prototype.submitForm=function(t){t.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(t,e){return new s(t,e)}}});