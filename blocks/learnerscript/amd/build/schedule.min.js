define(["jquery","core/ajax","block_learnerscript/ajax","core/event","block_learnerscript/select2","block_learnerscript/report","core/str"],function(l,s,r,c,e,i,o){return schedule={schreportform:function(r){s.call([{methodname:"block_learnerscript_schreportform",args:{reportid:r.reportid,instance:r.instanceid}}])[0].done(function(e){e=l.parseJSON(e),l("body").append("<div class='schreportform"+r.instanceid+"'>"+e+"</div>");var s="<img class='dialog_title_icon' alt='Scheduled Report' src='"+M.util.image_url("schedule_icon","block_learnerscript")+"'/>";l(".schreportform"+r.instanceid).dialog({resizable:!0,autoOpen:!1,width:"90%",title:"Add schedule report",modal:!0,appendTo:"#inst"+r.instanceid,position:{my:"center",at:"center",of:"#reportcontainer"+r.instanceid},open:function(e,r){l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var t=l(".ui-icon-closethick").parent();l(t).attr({title:"Close"}),l(this).closest(".ui-dialog").find(".ui-dialog-title").html(s+"Schedule report")},close:function(e,r){l(this).dialog("destroy").remove()}}).dialog("open"),l("#id_role"+r.instanceid).select2(),this.SelectRoleUsers(),this.schformvalidation({reportid:r.reportid,form:"schform"+r.instanceid,reqclass:"schformreq"+r.instanceid,instanceid:r.instanceid})}).fail(function(e){})},ScheduledTimings:function(e){l("select[data-select2='1']").select2({theme:"classic"}),this.SelectRoleUsers(),l("#scheduledtimings").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:e}})},ViewSchUsersTable:function(e){l("#scheduledusers").dataTable({processing:!0,serverSide:!0,lengthMenu:[[5,10,25,50,-1],[5,10,25,50,"All"]],idisplaylength:5,ordering:!1,ajax:{method:"GET",url:M.cfg.wwwroot+"/blocks/learnerscript/components/scheduler/ajax.php",data:{action:"viewschusersdata",reportid:e.reportid,scheduleid:e.scheduleid,schuserslist:e.schuserslist}}})},schformvalidation:function(t){document.getElementById(t.form).addEventListener("submit",function(e){try{var r=i.validate_scheduled_reports_form(t)}catch(e){return!0}return void 0!==window.tinyMCE&&window.tinyMCE.triggerSave(),r||e.preventDefault(),!1})},validate_scheduled_reports_form:function(s){var i=this;skipClientValidation&&l(".schreportform"+s.instanceid).dialog("destroy").remove();var n=!0,o=(document.getElementById(s.form),!1);return l("[data-class='"+s.reqclass+"']").each(function(e,r){var t=l(r).data("element");(n=i.validate_scheduled_reports_form_element(r,t,s)&&n)||o||(o=!0,Y.use("moodle-core-event",function(){Y.Global.fire(M.core.globalEvents.FORM_ERROR,{formid:s.form,elementid:"id_error_"+t+s.instanceid}),document.getElementById("id_error_"+t+s.instanceid).focus()}))}),n},validate_scheduled_reports_form_element:function(e,r,t){if(null==e)return!0;var s="",i=new Array,n="",o=e.parentNode;if(null==e.name||null==o)return!0;for(;o&&"FORM"!=o.nodeName.toUpperCase();)o=o.parentNode;s=new Array;for(var a=0,l=0;l<e.options.length;l++)e.options[l].selected&&(s[a++]=e.options[l].value);return""!=s||i[r]||(i[r]=!0,n+=" - You must supply a value here."),this.qf_errorHandler(e,n,r,t)},qf_errorHandler:function(e,r,t,s){var i=l.Event(c.Events.FORM_FIELD_VALIDATION);if(l(e).trigger(i,r),i.isDefaultPrevented())return""==r;var n=e.parentNode;if(null==n||null==e.name)return!0;if(""!=r){var o;for((o=document.getElementById("id_error_"+t+s.instanceid))||((o=document.createElement("span")).id="id_error_"+t+s.instanceid,o.className="error",e.parentNode.insertBefore(o,e.parentNode.firstChild),document.getElementById(o.id).setAttribute("TabIndex","0"),document.getElementById(o.id).focus());o.firstChild;)o.removeChild(o.firstChild);return o.appendChild(document.createTextNode(r.substring(3)))," error"!=n.className.substr(n.className.length-6,6)&&"error"!=n.className&&(n.className+=" error",(a=document.createElement("br")).className="error",a.id="id_error_break_"+t+s.instanceid,o.parentNode.insertBefore(a,o.nextSibling)),!1}(o=document.getElementById("id_error_"+t+s.instanceid))&&o.parentNode.removeChild(o);var a=document.getElementById("id_error_break_"+t+s.instanceid);return a&&a.parentNode.removeChild(a)," error"==n.className.substr(n.className.length-6,6)?n.className=n.className.substr(0,n.className.length-6):"error"==n.className&&(n.className=""),!0},frequency_schedule:function(r){s.call([{methodname:"block_learnerscript_frequency_schedule",args:{frequency:l("#id_frequency"+r.reportinstance).val()}}])[0].done(function(e){e=l.parseJSON(e);var t="";e?l.each(e,function(e,r){t+="<option value = "+e+" >"+r+"</option>"}):t+="<option value=null > --SELECT-- </option>",l("#id_updatefrequency"+r.reportinstance).html(t)}).fail(function(e){})},manageschusers:function(n){o.get_string("manageschusers","block_learnerscript").then(function(e){s.call([{methodname:"block_learnerscript_manageschusers",args:{reportid:n.reportid,scheduleid:n.scheduleid,selectedroleid:JSON.stringify(n.selectedroleid),schuserslist:n.schuserslist,reportinstance:n.reportinstance}}])[0].done(function(e){var r,t,s;if(e=l.parseJSON(e),l("body").append("<div class='manageschusers'>"+e+"</div>"),"page-blocks-learnerscript-components-scheduler-schedule"==l("body").attr("id"))r="#scheduleform",s=t="center top";else{r=window,s=t="center";l(".manageschusers").addClass("notschuserspage")}var i=l(".manageschusers").dialog({resizable:!0,autoOpen:!1,width:"60%",title:"Manage Schedule Users",modal:!0,position:{my:t,at:s,of:r,within:r},close:function(e,r){l(this).dialog("destroy").remove()},open:function(){l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var e=l(".ui-icon-closethick").parent();l(e).attr({title:"Close"})}});l(".manageschusers").hasClass("notschuserspage")&&l(".manageschusers").parent().addClass("notinschpage");l(".selectrole"+n.reportid).select2(),i.dialog("open")}).fail(function(e){})})},getroleusers:function(r){var e=l(".selectrole"+r.reportid).val();this.validate_scheduled_reports_form({reportid:r.reportid,form:"assignform",reqclass:"rolereq"});var t=l(".removeselect").val();l("#addselect_searchtext").val().length<1?(template="<optgroup label='Enter a value in search.'></optgroup>",l("#"+r.type+"select"+r.reportid).html(template)):s.call([{methodname:"block_learnerscript_roleusers",args:{term:l("#addselect_searchtext").val(),type:r.type,reportid:r.reportid,roleid:JSON.stringify(e),scheduleid:r.scheduleid,bullkselectedusers:JSON.stringify(t)}}])[0].done(function(e){var t="";0<(e=l.parseJSON(e)).total_count?l.each(e.items,function(e,r){t+="<option value = "+r.id+" >"+r.fullname+"</option>"}):t+="<optgroup label='No results found.'></optgroup>",l("#"+r.type+"select"+r.reportid).html(t)}).fail(function(e){})},bulkmanageschusers:function(e){var r=l.map(l(".removeselect option"),function(e){return e.value});l("#schuserslist"+e.reportinstance).val(r);var t=l(".removeselect").find("option").clone();if(l("#id_users_data"+e.reportinstance).children("option").remove(),10<t.length){t.slice(0,10).attr("selected","selected").appendTo("#id_users_data"+e.reportinstance);var s=document.createElement("option");s.value="-1",s.innerHTML="View More",s.selected=!0,document.getElementById("id_users_data"+e.reportinstance).appendChild(s)}else l(".removeselect").find("option").clone().attr("selected","selected").appendTo("#id_users_data"+e.reportinstance);l(".manageschusers").dialog("close")},viewschusers:function(t){o.get_string("viewschusers","block_learnerscript").then(function(e){t.schuserslist=l("#schuserslist"+t.reportinstance).val(),r.call({methodname:"viewschuserstable",args:{action:"viewschuserstable",reportid:t.reportid,scheduleid:t.scheduleid,schuserslist:t.schuserslist},url:M.cfg.wwwroot+"/blocks/learnerscript/ajax.php"}).done(function(e){l("body").append("<div class='viewschuserstable'>"+e+"</div>");var r=l(".viewschuserstable").dialog({resizable:!0,autoOpen:!1,width:"60%",title:"View Scheduled Users",modal:!0,close:function(e,r){l(this).dialog("destroy").remove()},open:function(){l(this).closest(".ui-dialog").find(".ui-dialog-titlebar-close").removeClass("ui-dialog-titlebar-close").html("<span class='ui-button-icon-primary ui-icon ui-icon-closethick'></span>");var e=l(".ui-icon-closethick").parent();l(e).attr({title:"Close"})}});schedule.ViewSchUsersTable(t),r.dialog("open").prev(".ui-dialog-titlebar").css("color","#0C75B6")}).fail(function(e){})})},addschusers:function(e){var s,r=l(".schforms"+e.reportinstance+" #id_users_data"+e.reportinstance).val(),t=l(".schforms"+e.reportinstance+" #schuserslist"+e.reportinstance).val();if((s=t?(t=t.split(",")).concat(r):r)&&s.includes("-1")){var i=s.indexOf("-1");s.splice(i,1)}l("#id_users_data"+e.reportinstance).find("option").not(":selected").each(function(e,r){if(s&&s.includes(r.value)){var t=s.indexOf(r.value);s.splice(t,1)}});var n=s&&s.filter(function(e,r){return s.indexOf(e)==r});l("#schuserslist"+e.reportinstance).val(n)},SelectRoleUsers:function(){var r=l(".schform").data("reportid");require(["block_learnerscript/helper"],function(e){e.Select2Ajax({reportid:r,action:"rolewiseusers",maximumSelectionLength:10})})},rolewiseusers:function(e){l("#id_users_data"+e.reportinstance).val(null).trigger("change")}}});