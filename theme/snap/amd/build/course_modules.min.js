define(["jquery","core/ajax","theme_snap/util","theme_snap/ajax_notification","core/str"],function(a,b,c,d,e){var f=function(b,c){b.find(".snap-asset-completion-tracking").html(c),b.find(".btn-link").focus(),a(document).trigger("snapModuleCompletionChange",b)},g=function(){a(".course-content").on("submit","form.togglecompletion",function(c){c.preventDefault();var e=a(this);if(!e.hasClass("ajaxing")){var g=a(e).find('input[name="id"]').val(),h=a(e).find('input[name="completionstate"]').val(),i=a(e).parents("li.snap-asset").first();e.addClass("ajaxing"),b.call([{methodname:"theme_snap_course_module_completion",args:{id:g,completionstate:h},done:function(a){d.ifErrorShowBestMsg(a).done(function(b){e.removeClass("ajaxing"),b||f(i,a.completionhtml)})},fail:function(a){d.ifErrorShowBestMsg(a).then(function(){e.removeClass("ajaxing")})}}],!0,!0)}})},h=function(a,b){a.find(".pagemod-content").slideToggle("fast",function(){a.is(".state-expanded")?(a.attr("aria-expanded","true"),a.find(".pagemod-content").focus()):(a.attr("aria-expanded","false"),a.focus())}),b&&f(a,b)},i=function(){var b=".modtype_page .instancename,.pagemod-readmore,.pagemod-content .snap-action-icon";a(document).on("click",b,function(b){var g=a(this).closest(".modtype_page");c.scrollToElement(g);var i=g.hasClass("state-expanded");g.toggleClass("state-expanded");var j=g.find(".pagemod-readmore"),k=g.find(".pagemod-content");if(1==k.data("content-loaded")){h(g);var l=M.cfg.wwwroot+"/theme/snap/rest.php?action=read_page&contextid="+j.data("pagemodcontext");i||a.ajax({type:"GET",async:!0,url:l,success:function(a){d.ifErrorShowBestMsg(a).done(function(b){b||f(g,a.completionhtml)})}})}else if(i)h(g);else{var m=e.get_string("loading","theme_snap");a.when(m).done(function(a){g.find(".contentafterlink").prepend('<div class="ajaxstatus alert alert-info">'+a+"</div>")});var n=M.cfg.wwwroot+"/theme/snap/rest.php?action=get_page&contextid="+j.data("pagemodcontext");a.ajax({type:"GET",async:!0,url:n,success:function(a){d.ifErrorShowBestMsg(a).done(function(b){b||(k.prepend(a.html),k.data("content-loaded",1),g.find(".contentafterlink .ajaxstatus").remove(),h(g,a.completionhtml))})}})}b.preventDefault()})},j=function(b){var c=function(b,c){var d=a("#snap-light-box");return 0===d.length&&(a(b).append('<div id="snap-light-box" tabindex="-1"><div id="snap-light-box-content"></div><a id="snap-light-box-close" class="pull-right snap-action-icon snap-icon-close" href="#"><small>Close</small></a></div>'),a("#snap-light-box-close").click(function(a){a.preventDefault(),a.stopPropagation(),e(),"function"==typeof c&&c()}),d=a("#snap-light-box")),d},e=function(){var a=c();a.remove()},g=function(b,d,e){d=d?d:a("body");var f=c(d,e);if(b){var g=a("#snap-light-box-content");g.html(""),g.append(b)}f.addClass("state-visible")},h=a("body"),i='<div class="loadingstat three-quarters">'+Y.Escape.html(M.util.get_string("loading","theme_snap"))+"</div>";g(i,h,function(){a(b).attr("tabindex","-1").focus(),a(b).removeAttr("tabindex")}),a.ajax({type:"GET",async:!0,url:M.cfg.wwwroot+"/theme/snap/rest.php?action=get_media&contextid="+a(b).data("modcontext"),success:function(c){d.ifErrorShowBestMsg(c).done(function(d){d||(g(c.html,h),f(a(b),c.completionhtml),a(document).trigger("snapContentRevealed"),a("#snap-light-box").focus())})}})};return{init:function(){i(),g(),a(document).on("click","[data-action=hide],[data-action=show]",function(){a(this).closest("li.activity").toggleClass("draft")}),a(document).on("click",'.js-snap-media .snap-asset-link [href*="/mod/resource/view.php?id="]',function(b){j(a(this).closest(".snap-resource, .snap-extended-resource")),b.preventDefault()}),a(document).on("click",".snap-resource-card .snap-resource, .snap-extended-resource",function(b){var c=a(b.target),d="_self",e=a(c).closest(".snap-resource").find(".snap-asset-link a"),f="";e.length>0&&(f=a(e).attr("href"));var g=".snap-asset-completion-tracking, .snap-asset-actions, .contentafterlink a, .ally-actions",h=a(c).closest(g).length;if(!h){if(a(this).hasClass("js-snap-media"))j(this);else{if(""===f)return;"_blank"===a(e).attr("target")&&(d="_blank"),sessionStorage.setItem("lastMod",a(this).attr("id")),window.open(f,d)}b.preventDefault()}})}}});